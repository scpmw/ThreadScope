<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Language" content="en-gb" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>ThreadScope: A Graphical Profiler for Parallel and Concurrent Haskell 
Programs</title>
<style type="text/css">
h1 {
}
.title {
	font-size: xx-large;
	font-family: "Times New Roman";
}
.computer {
	font-family: "Microsoft Sans Serif";
	font-size: small;
}
h1 {
}
.h1 {
	font-family: "Times New Roman";
	font-size: medium;
	font-weight: bold;
}
.style1 {
	margin-bottom: 0px;
}
.style3 {
	font-family: "Times New Roman";
	font-size: medium;
	font-weight: normal;
}
</style>
</head>

<body>

<p><img alt="" src="threadscope.png" width="118" height="63" /> <strong>
<span class="title">ThreadScope</span></strong></p>
<p>17 November 2009</p>
<p>Donnie Jones, <a href="mailto:donnie@darthik.com" class="computer">
donnie@darthik.com</a> <br />
Simon Marlow, <a href="mailto:simonmar@microsoft.com" class="computer">
simonmar@microsoft.com</a>, <span class="computer">
<a href="http://www.haskell.org/~simonmar/">http://www.haskell.org/~simonmar/</a></span>
<br />
Satnam Singh, <a href="mailto:satnams@microsoft.com" class="computer">
satnams@microsoft.com</a>, <span class="computer">
<a href="http://research.microsoft.com/~satnams">http://research.microsoft.com/~satnams</a></span> </p>
<p class="h1">Overview</p>
<p>ThreadScope is a graphical viewer for thread profile information generated by 
the Glasgow Haskell compiler (GHC). An example of a synthetic trace profile is 
shown below:</p>
<p><img alt="" src="html/ch8.png" width="648" height="318" /></p>
<p>ThreadScope can be used to help debug performance issues with parallel and 
concurrent Haskell programs. The program has the following features.</p>
<ul>
	<li>The program displays the activity on each Haskell Execution Context 
	(HEC) which roughly corresponds to an operating system thread. For each 
	thread you can see whether it is running a Haskell thread or performing 
	garbage collection. You can find out information about when Haskell threads 
	are ready to run and information about why a Haskell thread was suspended.</li>
	<li>You can observe how threads migrate between HECs and you can observe 
	sparks being picked up for speculative execution.</li>
	<li>An activity profile indicates the rough utilization of the HECs and when 
	the number of HECs are greater than the number of processing cores this 
	gives a rough guide to the overall utilization.</li>
	<li>You can place bookmarks at various points in the time profile to help 
	with navigation.</li>
</ul>
<p class="h1">Using ThreadScope</p>
<p class="style3">To compile a program for parallel profiling use the
<span class="computer">-eventlog</span> flag and you will also want to use the
<span class="computer">-threaded</span> flag to compile with the multi-threaded 
runtime e.g.</p>
<p class="style3"><span class="computer">ghc -threaded -eventlog --make 
Wombat.hs</span></p>
<p class="style3">To execute a program and generate a profile us the
<span class="computer">-ls </span>flag after <span class="computer">+RTS:</span></p>
<p class="style3"><span class="computer">./Wombat +RTS -ls -N2</span></p>
<p class="style3">The <span class="computer">-N2 </span>flag specifies the use 
of two Haskell Execution Contexts (i.e. threads). Once the program has been run 
it will produce a profile file called <span class="computer">Wombat.eventlog</span> 
or <span class="computer">Wombat.exe.eventlog</span> (depending on your 
operating system). You can now view this file with threadscope by specifying the 
eventlog filename as a command line argument or by navigating to it from the 
File menu of ThreadScope.</p>
<p class="h1">Installing ThreadScope on Windows</p>
<p>Ideally you would use the <a href="http://hackage.haskell.org/platform/">
Haskell Platform</a>. However, ThreadScope has a dependency on Gtk2Hs (a 
graphical user-interface toolkit) which can only be used with GHC 6.10.3 (the 
current GHC is 6.10.4). Furthermore, you currently have to use the release 
candidate GHC 6.12.1 in order to compile and execute programs that produce 
profiles for ThreadScope. So (take a deep breath) this is what you need to 
download:</p>
<ul>
	<li>Install the <a href="http://darcs.haskell.org/~ghc/dist/6.12.1rc1/">GHC 
	6.12.1 release candidate</a> which is need to compile and run programs you 
	want to profile. </li>
	<li class="style1">Install
	<a href="http://haskell.org/ghc/download_ghc_6_10_3.html#windows">GHC 6.10.3</a> 
	which you need to compile ThreadScope.</li>
	<li class="style1">&nbsp;Install
	<a href="http://wiki.darcs.net/Binaries#microsoft-windows">darcs</a> (unless 
	you already have it).</li>
	<li class="style1">Install
	<a href="http://www.haskell.org/cabal/download.html">cabal </a>(unless you 
	already have it).</li>
	<li class="style1">Install <a href="http://haskell.org/gtk2hs/download/">
	Gtk2Hs</a> version 0.10.1.</li>
	<li class="style1">Get the ThreadScope source:<br />
	<span class="computer">&nbsp;&nbsp;&nbsp; darcs get http://code.haskell.org/ThreadScope</span></li>
	<li class="style1">Move into the ThreadScope directory and then cabal 
	install ThreadScope using the -w flag to specify the location of where you 
	installed GHC 6.10.3:<br />
&nbsp;&nbsp;&nbsp; <span class="computer">cabal install -w c:/ghc/ghc-6.10.3/bin/ghc</span></li>
</ul>
<p>You can now try to run ThreadScope to make sure it built correctly by viewing 
the built in sample trace shown above:</p>
<p class="computer">threadscope --test ch8</p>
<p>Now check to see if you can compile and profile one of the sample programs. 
Move into the tests directory and type:</p>
<p>&lt;path of release candidate&gt;<span class="computer">/ghc -threaded -eventlog 
--make ParFib.hs</span></p>
<p>Now run the ParFib binary and create the event log:</p>
<p>./ParFib +RTS -ls -N2</p>
<p>Now view the eventlog which should look something like this on a machine with 
two or more cores:</p>
<p><img alt="" src="html/parfib.png" width="648" height="246" /></p>
<p class="h1">Installing under Linux</p>
<ul>
	<li>Install GHC (any 6.10 verison).</li>
	<li>Install gtk2hs</li>
	<li>Install darcs</li>
	<li>Download the 6.12 release candidate to your home directory e.g. 
	~/ghc.6.12.0.20091011</li>
	<li>For the remaining steps please follow the Windows instructions.</li>
</ul>
<p>For example on Ubuntu or Debian you would type:</p>
<p class="MsoNormal">
<span style="font-size:10.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black" class="computer">sudo apt-get install ghc6<br />
sudo apt-get install gtk2hs<br />
sudo apt-get install darcs<o:p></o:p></span></p>
<p class="h1">More Information</p>
<ul>
	<li><a href="http://research.microsoft.com/apps/pubs/default.aspx?id=80976">
	Parallel Performance Tuning for Haskell</a>.</li>
	<li><a href="http://research.microsoft.com/apps/pubs/default.aspx?id=79856">
	Runtime Support for Multicore Haskell</a>. </li>
	<li><a href="http://research.microsoft.com/apps/pubs/default.aspx?id=74058">
	A Tutorial on Parallel and Concurrent Programming in Haskell</a></li>
</ul>

</body>

</html>
